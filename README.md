#include <91x_lib.h>
#include "LCD.h"



#define   LED GPIO7->DR[0x3FC] //????? ???
#define   SW GPIO3->DR[0x3FC] //????? ??????


/////////////dlay  ??????? ?????? ?? ??? ?????? ////////////
void dlay(int i);
int measure(void);

void dlay(int i)
{
	int j, k;
	for (j = 1; j < 100; j++)
	{
		for (k = 0; k < i; k++);
	}
}
/////////??????? ??????? ?? ???? ????? ?? ????

int measure(void)
{
	ADC->CR &= 0xFF7f;
	ADC->CR = 0x0002;

	ADC->CR |= 0x0001;
	dlay(20000);

	//??? 8000 ?? ???A15 // ????? ????? ??? ??????? ????? ?????

	while (((ADC->CR) & 0x8000) == 0); // wait for end of converge
	//void ????? ??? ???????? ????? ?? ???? ?? ??????? ??????? ??
	return ((ADC->DR0) & 0x03FF);
}

/////////////////??????? ?????//////////////////
int main(void)
{

	// int ????? ?????? ?????? ??????
	unsigned int  x = 0, y = 1, bdika = 1, psila = 8, Place11 = 14, Place12 = 9, Place13 = 3, Place21 = 12, Place22 = 6, Place23 = 0, n = 1, td, meas;
	// char ????? ?????? ?????? ??????
	char Nline, tav;
	/* LCD Setup                                                                */
	GPIO8->DDR = 0xFF;                /* P8.0..7 Outputs (LCD Data)       */
	GPIO9->DDR = 0x07;                /* P9.0..2 Outputs (LCD Control)    */
	Intio();
	Int_a2d();
	lcd_init();// initial the LCD display
	LED = 0xFF;
	//??? ??? ???? ??????? ?? ????? ????? ?? ????? ????
	while (bdika)
	{
		//????? ?? ????? ???????? ?? ???? ??? ??? ???? ????? TD
		meas = measure();
		td = 40 * meas;
		lcd_clear();

		/////////////////????? ???????? ?? ????//////////////////

		set_cursor(Place11, x); // top row//???? ??????
		lcd_putchar('|');

		set_cursor(Place21, y); // 2nd row//???? 2
		lcd_putchar('|');

		set_cursor(Place12, x); // top row, 2nd char
		lcd_putchar('|');

		set_cursor(Place22, y); // 2nd row,2nd char
		lcd_putchar('|');

		set_cursor(Place13, x); // top row, 3rd char
		lcd_putchar('|');

		set_cursor(Place23, y); // 2nd row,3rd char
		lcd_putchar('|');

		/////////////////???? ????? ?????? ????????//////////////////

		Place11 = (Place11 - 1) % 15;
		if (Place11 == 0)
			Place11 = 15;


		Place12 = (Place12 - 1) % 15;
		if (Place12 == 0)
			Place12 = 15;

		Place13 = (Place13 - 1) % 15;
		if (Place13 == 0)
			Place13 = 15;

		Place21 = (Place21 - 1) % 15;
		if (Place21 == 0)
			Place21 = 15;

		Place22 = (Place22 - 1) % 15;
		if (Place22 == 0)
			Place22 = 15;

		Place23 = (Place23 - 1) % 15;
		if (Place23 == 0)
			Place23 = 15;


		if ((SW & 0X40) == 0)     //???? ????? ????? ????? ??????
			Nline = 0;
		dlay(td);
		if ((SW & 0X20) == 0) //???? ????? ???? ????? ??????
			Nline = 1;
		dlay(td);
		set_cursor(5, Nline); // object place//????? ?????
		lcd_putchar('>'); //????? ????? ?? ????

		//????? ?? ???????? ?????? ??????
		if ((Place11 == 4 && (x == Nline)) || (Place12 == 4 && (x == Nline)) || (Place13 == 4 && (x == Nline)) || (Place21 == 4 && (y == Nline)) || (Place22 == 4 && (y == Nline)) || (Place23 == 4 && (y == Nline)))
		{
			psila--; // ????? ?? ???? ???????  
			LED /= 2; //????? ?????? led=ff=255(DEC)=11111111(BIN)/2 = 127(DEC)=01111111(BIN) ????? ?????? ??????? ????
		}
		if (psila == 0)
			bdika = 0;

		dlay(td);

	}

	while (1)
	{
		set_cursor(1, 0);
		lcd_print("you lost");// "????? ?? ???? ??????? ????? ???? ?? ???? ????? "?????
		break;
	}

}
